-- FUNCTION: public.tr_fc_eggsbatchexplorations_delete()

-- DROP FUNCTION public.tr_fc_eggsbatchexplorations_delete();

CREATE FUNCTION public.tr_fc_eggsbatchexplorations_delete()
    RETURNS trigger
    LANGUAGE 'plpgsql'
    COST 100
    VOLATILE NOT LEAKPROOF
AS $BODY$
DECLARE
	v_quantity_EggsBatchProducts integer default 0;
	v_quantity_EggsBatchExplorations integer default 0;
	v_new_quantity_EggsBatchExplorations integer default 0;
BEGIN	
	SELECT COALESCE(SUM("quantity"),0)
	  INTO v_quantity_EggsBatchExplorations
	  FROM public."EggsBatchExplorations"
	 WHERE "EggsBatchId" = OLD."EggsBatchId";
	 
	 v_new_quantity_EggsBatchExplorations = 
	 	v_quantity_EggsBatchExplorations - OLD."quantity";
	
	SELECT COALESCE(SUM("quantity"),0)
	  INTO v_quantity_EggsBatchProducts
	  FROM public."EggsBatchProducts"
	 WHERE "EggsBatchId" = OLD."EggsBatchId";
	 	
	IF(v_new_quantity_EggsBatchExplorations < v_quantity_EggsBatchProducts) THEN
		RAISE EXCEPTION 'quantity cannot be lower than the current quantity in EggsBatchProduct';
	END IF;
	
	RETURN OLD;
END;
$BODY$;

ALTER FUNCTION public.tr_fc_eggsbatchexplorations_delete()
    OWNER TO postgres;
